!function(a){"use strict";function b(a,b,c){for(var d=[],e=0;a>e;e++){d[e]=[];for(var f=0;b>f;f++)d[e][f]=c&&c[e][f]?1:0}return d}a.Util={create2DArray:b}}(window),function(a){"use strict";function b(){this.left=3,this.top=0,this.locked=!1,this.matrixNum=4,this.rotateFlag=!1,this.matrix=[[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0]]}function c(){b.call(this),this.left=2,this.top=-3,this.color=2,this.matrix[2][0]=this.color,this.matrix[2][1]=this.color,this.matrix[2][2]=this.color,this.matrix[2][3]=this.color}function d(){b.call(this),this.top=-2,this.color=3,this.matrix[0][2]=this.color,this.matrix[1][2]=this.color,this.matrix[1][1]=this.color,this.matrix[2][1]=this.color}function e(){b.call(this),this.top=-2,this.color=4,this.matrix[1][1]=this.color,this.matrix[1][2]=this.color,this.matrix[2][1]=this.color,this.matrix[2][2]=this.color}function f(){b.call(this),this.matrixNum=3,this.matrix=[[0,0,0],[0,0,0],[0,0,0]],this.top=-2,this.color=5,this.matrix[0][1]=this.color,this.matrix[1][1]=this.color,this.matrix[1][2]=this.color,this.matrix[2][1]=this.color}function g(){b.call(this),this.top=-2,this.color=6,this.matrix[0][1]=this.color,this.matrix[1][1]=this.color,this.matrix[1][2]=this.color,this.matrix[2][2]=this.color}function h(){b.call(this),this.top=-2,this.color=7,this.matrix[0][2]=this.color,this.matrix[1][2]=this.color,this.matrix[2][2]=this.color,this.matrix[2][1]=this.color}function i(){b.call(this),this.top=-2,this.color=8,this.matrix[1][1]=this.color,this.matrix[1][2]=this.color,this.matrix[2][2]=this.color,this.matrix[3][2]=this.color}b.prototype.moveLeft=function(){this.locked||this.left--},b.prototype.moveRight=function(){this.locked||this.left++},b.prototype.moveUp=function(){this.locked||this.top--},b.prototype.moveDown=function(){this.locked||this.top++},b.prototype.rotateLeft=function(){if(!this.locked){for(var a=Util.create2DArray(this.matrixNum,this.matrixNum),b=0;b<this.matrixNum;b++)for(var c=0;c<this.matrixNum;c++)a[b][c]=this.matrix[c][this.matrixNum-1-b];this.matrix=a}},b.prototype.rotateRight=function(){if(!this.locked){for(var a=Util.create2DArray(this.matrixNum,this.matrixNum),b=0;b<this.matrixNum;b++)for(var c=0;c<this.matrixNum;c++)a[c][this.matrixNum-1-b]=this.matrix[b][c];this.matrix=a}},b.prototype.getPoints=function(){for(var a=[],b=0;b<this.matrixNum;b++)for(var c=0;c<this.matrixNum;c++)this.matrix[b][c]&&a.push({x:this.left+b,y:this.top+c});return a},b.prototype.getColor=function(){return this.color||0},c.prototype=new b,c.prototype.constructor=c,c.prototype.rotateLeft=function(){this.rotateFlag?(this.rotateFlag=!1,b.prototype.rotateRight.call(this)):(b.prototype.rotateLeft.call(this),this.rotateFlag=!0)},d.prototype=new b,d.prototype.constructor=d,d.prototype.rotateLeft=function(){this.rotateFlag?(this.rotateFlag=!1,b.prototype.rotateRight.call(this)):(b.prototype.rotateLeft.call(this),this.rotateFlag=!0)},e.prototype=new b,e.prototype.constructor=e,e.prototype.rotateRight=function(){},e.prototype.rotateLeft=function(){},f.prototype=new b,f.prototype.constructor=f,g.prototype=new b,g.prototype.constructor=g,g.prototype.rotateLeft=function(){this.rotateFlag?(this.rotateFlag=!1,b.prototype.rotateRight.call(this)):(b.prototype.rotateLeft.call(this),this.rotateFlag=!0)},h.prototype=new b,h.prototype.constructor=h,i.prototype=new b,i.prototype.constructor=i,a.Tetromino={create:function(a){a=a||Math.floor(7*Math.random()),console.log("Create tetromino type : "+a);var b=null;switch(a){case 0:b=new c;break;case 1:b=new e;break;case 2:b=new h;break;case 3:b=new i;break;case 4:b=new d;break;case 5:b=new g;break;case 6:b=new f;break;default:return null}return b.num=a,b}}}(window),function(a,b){"use strict";function c(a){var c="keyboard",d="touch";if(a&&a===c&&a===d||(a=c),this.type=a,this.receiver=null,this.receiverContext=null,this.type===c){var e=this;b(window).on("keydown",function(a){e.receiver&&e.receiverContext&&e.receiver.apply(e.receiverContext,[a])})}else this.type===d}c.prototype.setReceiver=function(a,b){this.receiver=a,this.receiverContext=b},a.InputHandler=c}(window,jQuery),function(a){"use strict";function b(a,b){console.log("Grid constructor"),this.inputHandler=b,this.eventHandler=null,this.eventContext=null,this.canvasId=a,this.cols=10,this.rows=15,this.gridWidth=300,this.gridHeight=450,this.gridPadding=5,this.cellWidth=30,this.paused=!1,this.speed=2,this.gameResult=!1,this.forceStopFlag=!1,this.setInputType(1),this.colorMap={0:"",1:"",2:"aqua",3:"green",4:"gold",5:"indigo",6:"red",7:"blue",8:"darkorange"},this.gameOver=!1,this.tetrominoNew=!0,this.score=0,this.matrix=Util.create2DArray(this.cols,this.rows),this.canvas=document.getElementById(this.canvasId),this.context=this.canvas&&this.canvas.getContext("2d"),this.cleanGrid(),this.inputHandler.setReceiver(this.handleInput,this)}b.prototype.cleanGrid=function(){this.context.fillStyle="white",this.context.fillRect(0,0,this.canvas.width,this.canvas.height);for(var a=0;a<=this.gridWidth;a+=this.cellWidth)this.context.moveTo(.5+a+this.gridPadding,this.gridPadding),this.context.lineTo(.5+a+this.gridPadding,this.gridHeight+this.gridPadding);for(var b=0;b<=this.gridHeight;b+=this.cellWidth)this.context.moveTo(this.gridPadding,.5+b+this.gridPadding),this.context.lineTo(this.gridWidth+this.gridPadding,.5+b+this.gridPadding);this.context.strokeStyle="black",this.context.stroke()},b.prototype.setInputType=function(a){1===a?(this.KEY_UP=38,this.KEY_DOWN=40,this.KEY_RIGHT=39,this.KEY_LEFT=37):2===a&&(this.KEY_UP=87,this.KEY_DOWN=83,this.KEY_RIGHT=68,this.KEY_LEFT=65)},b.prototype.setQuiet=function(a){this.quiet=!!a},b.prototype.forceStop=function(a){this.gameOver=!0,this.gameResult=!!a,this.forceStopFlag=!0},b.prototype.cleanFilledRows=function(){var a,b,c,d,e=[];for(a=0;a<this.rows;a++){var f=!0;for(b=0;b<this.cols;b++)this.matrix[b][a]||(f=!1);f&&(this.score+=10,e.push(a))}for(a=0,b=this.matrix.length;b>a;a++){var g=this.matrix[a];for(c=0,d=e.length;d>c;c++){var h=e[c];g.splice(h,1),g.unshift(0)}}},b.prototype.hideTetromino=function(){if(this.tetromino)for(var a=this.tetromino.getPoints(),b=0,c=a.length;c>b;b++)this.matrix[a[b].x][a[b].y]=0},b.prototype.showTetromino=function(){if(this.tetromino)for(var a=this.tetromino.getPoints(),b=this.tetromino.getColor()||1,c=0,d=a.length;d>c;c++){var e=a[c].x,f=a[c].y;e>=0&&f>=0&&(this.matrix[e][f]=b)}},b.prototype.checkValid=function(){for(var a=this.tetromino.getPoints(),b=0,c=a.length;c>b;b++){if(a[b].x===this.cols||-1===a[b].x)return!1;if(this.matrix[a[b].x][a[b].y])return!1;if(a[b].y>=this.rows)return!1}return!0},b.prototype.checkGameOver=function(){for(var a=this.tetromino.getPoints(),b=0,c=a.length;c>b;b++)if(a[b].y<=0)return this.gameOver=!0,console.log("Game over! Your score: "+this.score),!0;return!1},b.prototype.checkNewTetromino=function(){this.tetrominoNew&&(this.cleanFilledRows(),this.tetromino=this.getTetromino())},b.prototype.render=function(){this.cleanGrid();for(var a,b,c,d,e=0;e<this.cols;e++)for(var f=0;f<this.rows;f++)c=this.matrix[e][f],d=this.colorMap[c],c&&d&&(this.context.fillStyle=d,a=.5+e*this.cellWidth+this.gridPadding,b=.5+f*this.cellWidth+this.gridPadding,this.context.fillRect(a,b+1,this.cellWidth-1,this.cellWidth-1))},b.prototype.run=function(){this.tetromino&&(this.tetrominoNew?(this.showTetromino(),this.tetrominoNew=!1):(this.hideTetromino(),this.tetromino.moveDown(),this.checkValid()||(this.tetromino.moveUp(),this.tetromino.moveDown(),this.checkValid()||(this.tetromino.moveUp(),this.tetrominoNew=!0,this.tetromino.locked=!0,this.checkGameOver())),this.showTetromino()))},b.prototype.start=function(){var a=this,b=function(){if(a.gameOver){if(!a.quiet&&a.eventHandler){var c={event:"stop",data:{score:a.score,id:a.canvasId,win:a.gameResult,forceStop:a.forceStopFlag}};a.eventHandler.apply(a.eventContext,[c])}a.cleanGrid()}else a.paused||(a.checkNewTetromino(),a.run(),a.render()),setTimeout(function(){requestAnimationFrame(b)},1e3/a.speed)};b()},b.prototype.getTetromino=function(){return Tetromino.create()},b.prototype.setEventHandler=function(a,b){this.eventHandler=a,this.eventContext=b},b.prototype.togglePause=function(a){return this.paused=void 0!==a?!!a:!this.paused,this.paused},b.prototype.handleInput=function(a){var b=a.keyCode;if(b&&(console.log("Grid "+this.canvasId+" handleInput : "+b),!this.tetrominoNew&&this.tetromino))switch(b){case this.KEY_LEFT:this.hideTetromino(),this.tetromino.moveLeft(),this.checkValid()||this.tetromino.moveRight(),this.showTetromino();break;case this.KEY_UP:this.hideTetromino(),this.tetromino.rotateLeft(),this.checkValid()||this.tetromino.rotateRight(),this.showTetromino();break;case this.KEY_RIGHT:this.hideTetromino(),this.tetromino.moveRight(),this.checkValid()||this.tetromino.moveLeft(),this.showTetromino();break;case this.KEY_DOWN:this.hideTetromino(),this.tetromino.moveDown(),this.checkValid()||this.tetromino.moveUp(),this.showTetromino()}},a.Grid=b}(window),$(function(){"use strict";function a(a){var e,f=a.data;if(f&&!d.gameEnded){var g=+f.id.slice(-1);e=1===g?2:1,b.forceStop(!0),c.forceStop(!0),d.gameEnded=!0,b=null,c=null,f.forceStop||window.alert("Woo! Player"+e+" win!"),$(".canvas-panel").hide(400,function(){$(".menu-panel").show()})}}!function(){for(var a=0,b=["ms","moz","webkit","o"],c=0;c<b.length&&!window.requestAnimationFrame;++c)window.requestAnimationFrame=window[b[c]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[b[c]+"CancelAnimationFrame"]||window[b[c]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(b){var c=(new Date).getTime(),d=Math.max(0,16-(c-a)),e=window.setTimeout(function(){b(c+d)},d);return a=c+d,e}),window.cancelAnimationFrame||(window.cancelAnimationFrame=function(a){clearTimeout(a)})}();var b,c,d={gameMode:"",gameEnded:!1};$("#single-play-btn").click(function(){var a=new InputHandler;b=new Grid("canvas",a),b.setInputType(1),b.setEventHandler(function(a){var c=+(a.data&&a.data.score);a.data&&!a.data.forceStop&&window.alert("Game Over! Your score : "+c),d.gameEnded=!0,b=null,$(".canvas-panel").hide(400,function(){$(".menu-panel").show()})}),d.gameMode="single",d.gameEnded=!1,$(".menu-panel").hide(),$(".one-canvas-panel").show(400,function(){b.start()})}),$("#double-play-btn").click(function(){var e=new InputHandler,f=new InputHandler;b=new Grid("canvas1",e),c=new Grid("canvas2",f),b.setInputType(2),c.setInputType(1),b.setEventHandler(a),c.setEventHandler(a),d.gameMode="double",d.gameEnded=!1,$(".menu-panel").hide(),$(".two-canvas-panel").show(400,function(){b.start(),c.start()})}),$("button.pause-game").click(function(a){var e,f;switch(d.gameMode){case"single":e=b.togglePause(a.pause);break;case"double":e=b.togglePause(a.pause),e=c.togglePause(a.pause)}f=e?"继续":"暂停",$("button.pause-game").text(f)}),$("button.return-home").click(function(){var a,e;switch(d.gameMode){case"single":e=b.togglePause(!0),a=window.confirm("确定要中断游戏并返回菜单?"),a?($("button.pause-game").text("暂停"),b.forceStop(!0),d.gameMode=""):e=this.togglePause(!1);break;case"double":e=b.togglePause(!0)&&c.togglePause(!0),a=window.confirm("确定要中断游戏并返回菜单?"),a?($("button.pause-game").text("暂停"),b.forceStop(!0),c.forceStop(!0),d.gameMode=""):e=this.togglePause(!1)}}),$("#about-btn").click(function(){window.open("https://github.com/jarontai/tetris")})});