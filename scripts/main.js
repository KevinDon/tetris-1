!function(t){"use strict";function i(t,i,e){for(var o=[],r=0;t>r;r++){o[r]=[];for(var s=0;i>s;s++)o[r][s]=e&&e[r][s]?1:0}return o}t.Util={create2DArray:i}}(window),function(t){"use strict";function i(){this.left=3,this.top=0,this.locked=!1,this.matrixNum=4,this.rotateFlag=!1,this.matrix=[[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0]]}function e(){i.call(this),this.left=2,this.top=-3,this.color=2,this.matrix[2][0]=this.color,this.matrix[2][1]=this.color,this.matrix[2][2]=this.color,this.matrix[2][3]=this.color}function o(){i.call(this),this.top=-2,this.color=3,this.matrix[0][2]=this.color,this.matrix[1][2]=this.color,this.matrix[1][1]=this.color,this.matrix[2][1]=this.color}function r(){i.call(this),this.top=-2,this.color=4,this.matrix[1][1]=this.color,this.matrix[1][2]=this.color,this.matrix[2][1]=this.color,this.matrix[2][2]=this.color}function s(){i.call(this),this.matrixNum=3,this.matrix=[[0,0,0],[0,0,0],[0,0,0]],this.top=-2,this.color=5,this.matrix[0][1]=this.color,this.matrix[1][1]=this.color,this.matrix[1][2]=this.color,this.matrix[2][1]=this.color}function n(){i.call(this),this.top=-2,this.color=6,this.matrix[0][1]=this.color,this.matrix[1][1]=this.color,this.matrix[1][2]=this.color,this.matrix[2][2]=this.color}function a(){i.call(this),this.top=-2,this.color=7,this.matrix[0][2]=this.color,this.matrix[1][2]=this.color,this.matrix[2][2]=this.color,this.matrix[2][1]=this.color}function h(){i.call(this),this.top=-2,this.color=8,this.matrix[1][1]=this.color,this.matrix[1][2]=this.color,this.matrix[2][2]=this.color,this.matrix[3][2]=this.color}i.prototype.moveLeft=function(){this.locked||this.left--},i.prototype.moveRight=function(){this.locked||this.left++},i.prototype.moveUp=function(){this.locked||this.top--},i.prototype.moveDown=function(){this.locked||this.top++},i.prototype.rotateLeft=function(){if(!this.locked){for(var t=Util.create2DArray(this.matrixNum,this.matrixNum),i=0;i<this.matrixNum;i++)for(var e=0;e<this.matrixNum;e++)t[i][e]=this.matrix[e][this.matrixNum-1-i];this.matrix=t}},i.prototype.rotateRight=function(){if(!this.locked){for(var t=Util.create2DArray(this.matrixNum,this.matrixNum),i=0;i<this.matrixNum;i++)for(var e=0;e<this.matrixNum;e++)t[e][this.matrixNum-1-i]=this.matrix[i][e];this.matrix=t}},i.prototype.getPoints=function(){for(var t=[],i=0;i<this.matrixNum;i++)for(var e=0;e<this.matrixNum;e++)this.matrix[i][e]&&t.push({x:this.left+i,y:this.top+e});return t},i.prototype.getColor=function(){return this.color||0},e.prototype=new i,e.prototype.constructor=e,e.prototype.rotateLeft=function(){this.rotateFlag?(this.rotateFlag=!1,i.prototype.rotateRight.call(this)):(i.prototype.rotateLeft.call(this),this.rotateFlag=!0)},o.prototype=new i,o.prototype.constructor=o,o.prototype.rotateLeft=function(){this.rotateFlag?(this.rotateFlag=!1,i.prototype.rotateRight.call(this)):(i.prototype.rotateLeft.call(this),this.rotateFlag=!0)},r.prototype=new i,r.prototype.constructor=r,r.prototype.rotateRight=function(){},r.prototype.rotateLeft=function(){},s.prototype=new i,s.prototype.constructor=s,n.prototype=new i,n.prototype.constructor=n,n.prototype.rotateLeft=function(){this.rotateFlag?(this.rotateFlag=!1,i.prototype.rotateRight.call(this)):(i.prototype.rotateLeft.call(this),this.rotateFlag=!0)},a.prototype=new i,a.prototype.constructor=a,h.prototype=new i,h.prototype.constructor=h,t.Tetromino={create:function(t){t=t||Math.floor(7*Math.random()),console.log("Create tetromino type : "+t);var i=null;switch(t){case 0:i=new e;break;case 1:i=new r;break;case 2:i=new a;break;case 3:i=new h;break;case 4:i=new o;break;case 5:i=new n;break;case 6:i=new s;break;default:return null}return i.num=t,i}}}(window),function(t,i){"use strict";function e(t){var e="keyboard",o="touch";if(t&&t===e&&t===o||(t=e),this.type=t,this.receiver=null,this.receiverContext=null,this.type===e){var r=this;i(window).on("keydown",function(t){r.receiver&&r.receiverContext&&r.receiver.apply(r.receiverContext,[t])})}else this.type===o}e.prototype.setReceiver=function(t,i){this.receiver=t,this.receiverContext=i},t.InputHandler=e}(window,jQuery),function(t){"use strict";function i(t,i){console.log("Grid constructor"),this.inputHandler=i,this.eventHandler=null,this.eventContext=null,this.canvasId=t,this.cols=10,this.rows=15,this.gridWidth=300,this.gridHeight=450,this.gridPadding=5,this.cellWidth=30,this.paused=!1,this.speed=2,this.gameResult=!1,this.forceStopFlag=!1,this.setInputType(1),this.colorMap={0:"",1:"",2:"Aqua",3:"green",4:"Gold",5:"Indigo",6:"red",7:"blue",8:"Darkorange"},this.gameOver=!1,this.tetrominoNew=!0,this.score=0,this.matrix=Util.create2DArray(this.cols,this.rows),this.canvas=document.getElementById(this.canvasId),this.context=this.canvas&&this.canvas.getContext("2d"),this.cleanGrid(),this.inputHandler.setReceiver(this.handleInput,this)}i.prototype.cleanGrid=function(){this.context.fillStyle="white",this.context.fillRect(0,0,this.canvas.width,this.canvas.height);for(var t=0;t<=this.gridWidth;t+=this.cellWidth)this.context.moveTo(.5+t+this.gridPadding,this.gridPadding),this.context.lineTo(.5+t+this.gridPadding,this.gridHeight+this.gridPadding);for(var i=0;i<=this.gridHeight;i+=this.cellWidth)this.context.moveTo(this.gridPadding,.5+i+this.gridPadding),this.context.lineTo(this.gridWidth+this.gridPadding,.5+i+this.gridPadding);this.context.strokeStyle="black",this.context.stroke()},i.prototype.setInputType=function(t){1===t?(this.KEY_UP=38,this.KEY_DOWN=40,this.KEY_RIGHT=39,this.KEY_LEFT=37):2===t&&(this.KEY_UP=87,this.KEY_DOWN=83,this.KEY_RIGHT=68,this.KEY_LEFT=65)},i.prototype.setQuiet=function(t){this.quiet=!!t},i.prototype.forceStop=function(t){this.gameOver=!0,this.gameResult=!!t,this.forceStopFlag=!0},i.prototype.cleanFilledRows=function(){var t,i,e,o,r=[];for(t=0;t<this.rows;t++){var s=!0;for(i=0;i<this.cols;i++)this.matrix[i][t]||(s=!1);s&&(this.score+=10,r.push(t))}for(t=0,i=this.matrix.length;i>t;t++){var n=this.matrix[t];for(e=0,o=r.length;o>e;e++){var a=r[e];n.splice(a,1),n.unshift(0)}}},i.prototype.hideTetromino=function(){if(this.tetromino)for(var t=this.tetromino.getPoints(),i=0,e=t.length;e>i;i++)this.matrix[t[i].x][t[i].y]=0},i.prototype.showTetromino=function(){if(this.tetromino)for(var t=this.tetromino.getPoints(),i=this.tetromino.getColor()||1,e=0,o=t.length;o>e;e++){var r=t[e].x,s=t[e].y;r>=0&&s>=0&&(this.matrix[r][s]=i)}},i.prototype.checkValid=function(){for(var t=this.tetromino.getPoints(),i=0,e=t.length;e>i;i++){if(t[i].x===this.cols||-1===t[i].x)return!1;if(this.matrix[t[i].x][t[i].y])return!1;if(t[i].y>=this.rows)return!1}return!0},i.prototype.checkGameOver=function(){for(var t=this.tetromino.getPoints(),i=0,e=t.length;e>i;i++)if(t[i].y<=0)return this.gameOver=!0,console.log("Game over! Your score: "+this.score),!0;return!1},i.prototype.checkNewTetromino=function(){this.tetrominoNew&&(this.cleanFilledRows(),this.tetromino=this.getTetromino())},i.prototype.render=function(){this.cleanGrid();for(var t,i,e,o,r=0;r<this.cols;r++)for(var s=0;s<this.rows;s++)e=this.matrix[r][s],o=this.colorMap[e],e&&o&&(this.context.fillStyle=o,t=.5+r*this.cellWidth+this.gridPadding,i=.5+s*this.cellWidth+this.gridPadding,this.context.fillRect(t,i+1,this.cellWidth-1,this.cellWidth-1))},i.prototype.run=function(){this.tetromino&&(this.tetrominoNew?(this.showTetromino(),this.tetrominoNew=!1):(this.hideTetromino(),this.tetromino.moveDown(),this.checkValid()||(this.tetromino.moveUp(),this.tetromino.moveDown(),this.checkValid()||(this.tetromino.moveUp(),this.tetrominoNew=!0,this.tetromino.locked=!0,this.checkGameOver())),this.showTetromino()))},i.prototype.start=function(){var t=this,i=function(){if(t.gameOver){if(!t.quiet&&t.eventHandler){var e={event:"stop",data:{score:t.score,id:t.canvasId,win:t.gameResult,forceStop:t.forceStopFlag}};t.eventHandler.apply(t.eventContext,[e])}t.cleanGrid()}else t.paused||(t.checkNewTetromino(),t.run(),t.render()),setTimeout(function(){requestAnimationFrame(i)},1e3/t.speed)};i()},i.prototype.getTetromino=function(){return Tetromino.create()},i.prototype.setEventHandler=function(t,i){this.eventHandler=t,this.eventContext=i},i.prototype.togglePause=function(t){return this.paused=void 0!==t?!!t:!this.paused,this.paused},i.prototype.handleInput=function(t){var i=t.keyCode;if(i&&(console.log("GridView handleInput : "+i),!this.tetrominoNew&&this.tetromino))switch(i){case this.KEY_LEFT:this.hideTetromino(),this.tetromino.moveLeft(),this.checkValid()||this.tetromino.moveRight(),this.showTetromino();break;case this.KEY_UP:this.hideTetromino(),this.tetromino.rotateLeft(),this.checkValid()||this.tetromino.rotateRight(),this.showTetromino();break;case this.KEY_RIGHT:this.hideTetromino(),this.tetromino.moveRight(),this.checkValid()||this.tetromino.moveLeft(),this.showTetromino();break;case this.KEY_DOWN:this.hideTetromino(),this.tetromino.moveDown(),this.checkValid()||this.tetromino.moveUp(),this.showTetromino()}},t.Grid=i}(window),$(function(){"use strict";function t(t){var r,s=t.data;if(s&&!o.gameEnded){var n=+s.id.slice(-1);r=1===n?2:1,i.forceStop(!0),e.forceStop(!0),o.gameEnded=!0,s.forceStop||window.alert("Woo! Player"+r+" win!"),$(".canvas-panel").hide(400,function(){$(".menu-panel").show()})}}!function(){for(var t=0,i=["ms","moz","webkit","o"],e=0;e<i.length&&!window.requestAnimationFrame;++e)window.requestAnimationFrame=window[i[e]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[i[e]+"CancelAnimationFrame"]||window[i[e]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(i){var e=(new Date).getTime(),o=Math.max(0,16-(e-t)),r=window.setTimeout(function(){i(e+o)},o);return t=e+o,r}),window.cancelAnimationFrame||(window.cancelAnimationFrame=function(t){clearTimeout(t)})}();var i,e,o={gameMode:"",gameEnded:!1};$("#single-play-btn").click(function(){var t=new InputHandler;i=new Grid("canvas",t),i.setInputType(1),i.setEventHandler(function(t){var i=+(t.data&&t.data.score);t.data&&!t.data.forceStop&&window.alert("Game Over! Your score : "+i),o.gameEnded=!0,$(".canvas-panel").hide(400,function(){$(".menu-panel").show()})}),o.gameMode="single",o.gameEnded=!1,$(".menu-panel").hide(),$(".one-canvas-panel").show(400,function(){i.start()})}),$("#double-play-btn").click(function(){var r=new InputHandler,s=new InputHandler;i=new Grid("canvas1",r),e=new Grid("canvas2",s),i.setInputType(2),e.setInputType(1),i.setEventHandler(t),e.setEventHandler(t),o.gameMode="double",o.gameEnded=!1,$(".menu-panel").hide(),$(".two-canvas-panel").show(400,function(){i.start(),e.start()})}),$("button.pause-game").click(function(t){var r,s;switch(o.gameMode){case"single":r=i.togglePause(t.pause);break;case"double":r=i.togglePause(t.pause),r=e.togglePause(t.pause)}s=r?"继续":"暂停",$("button.pause-game").text(s)}),$("button.return-home").click(function(){var t,r;switch(o.gameMode){case"single":r=i.togglePause(!0),t=window.confirm("确定要中断游戏并返回菜单?"),t?($("button.pause-game").text("暂停"),i.forceStop(!0),o.gameMode=""):r=this.togglePause(!1);break;case"double":r=i.togglePause(!0)&&e.togglePause(!0),t=window.confirm("确定要中断游戏并返回菜单?"),t?($("button.pause-game").text("暂停"),i.forceStop(!0),e.forceStop(!0),o.gameMode=""):r=this.togglePause(!1)}}),$("#about-btn").click(function(){})});